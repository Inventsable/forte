<template>
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1460 180" @mouseleave="mouseState = false;">
    <rect class="keyboard-bg" width="1460" height="180" />
    <g id="piano">
      <polygon
        v-for="(key, i) in realKeys"
        :key="i"
        :points="key.points"
        :class="key.class"
        :style="styleKey(key)"
        @mouseenter="hoverKey(key, true)"
        @mouseleave="hoverKey(key, false)"
        @mousedown="clickedKey(key, true)"
        @mouseup="clickedKey(key, false)"
      />
    </g>
  </svg>
</template>

<script>
export default {
  data: () => ({
    keys: [
      {
        points:
          "32.41 116.5 32.41 175.5 6.57 175.5 6.57 116.5 6.58 116.5 6.58 4.5 28.27 4.5 28.27 116.5 32.41 116.5"
      },
      {
        points:
          "42.27 4.5 42.27 59.49 42.27 114.5 36.27 114.5 30.27 114.5 30.27 59.49 30.27 4.5 36.27 4.5 42.27 4.5"
      },
      {
        points:
          "60.27 4.5 60.27 175.5 34.41 175.5 34.41 116.5 44.27 116.5 44.27 4.5 60.27 4.5"
      },
      {
        points:
          "80.08 116.5 88.44 116.5 88.44 175.5 62.58 175.5 62.58 4.5 80.08 4.5 80.08 116.5"
      },
      {
        points:
          "94.08 4.5 94.08 59.49 94.08 114.5 88.08 114.5 82.08 114.5 82.08 59.49 82.08 4.5 88.08 4.5 94.08 4.5"
      },
      {
        points:
          "116.53 175.46 90.67 175.53 90.5 116.5 96.08 116.5 96.08 4.51 112.58 4.46 112.58 116.5 116.36 116.5 116.53 175.46"
      },
      {
        points:
          "126.58 4.5 126.58 59.49 126.58 114.5 120.58 114.5 114.58 114.5 114.58 59.49 114.58 4.5 120.58 4.5 126.58 4.5"
      },
      {
        points:
          "144.15 4.5 144.15 175.5 118.28 175.5 118.28 116.5 128.57 116.5 128.57 4.5 144.15 4.5"
      },
      {
        points:
          "172 116.5 172 175.5 146.15 175.5 146.15 4.5 161.07 4.5 161.07 116.5 172 116.5"
      },
      {
        points:
          "175.07 4.5 175.07 59.49 175.07 114.5 169.07 114.5 163.07 114.5 163.07 59.49 163.07 4.5 169.07 4.5 175.07 4.5"
      },
      {
        points:
          "199.87 116.5 199.87 175.5 174 175.5 174 116.5 177.07 116.5 177.07 4.5 193.57 4.5 193.57 116.5 199.87 116.5"
      },
      {
        points:
          "207.57 4.5 207.57 59.49 207.57 114.5 201.57 114.5 195.57 114.5 195.57 59.49 195.57 4.5 201.57 4.5 207.57 4.5"
      },
      {
        points:
          "227.72 116.5 227.72 175.5 201.87 175.5 201.87 116.5 209.57 116.5 209.57 4.5 223.57 4.5 223.57 116.5 227.72 116.5"
      },
      {
        points:
          "237.57 4.5 237.57 59.49 237.57 114.5 231.57 114.5 225.57 114.5 225.57 59.49 225.57 4.5 231.57 4.5 237.57 4.5"
      },
      {
        points:
          "255.57 4.5 255.57 175.5 229.72 175.5 229.72 116.5 239.57 116.5 239.57 4.5 255.57 4.5"
      },
      {
        points:
          "275.07 116.5 283.44 116.5 283.44 175.5 257.57 175.5 257.57 4.5 275.07 4.5 275.07 116.5"
      },
      {
        points:
          "289.07 4.5 289.07 59.49 289.07 114.5 283.07 114.5 277.07 114.5 277.07 59.49 277.07 4.5 283.07 4.5 289.07 4.5"
      },
      {
        points:
          "311.52 175.46 285.68 175.53 285.5 116.5 291.07 116.5 291.07 4.51 307.57 4.46 307.57 116.5 311.36 116.5 311.52 175.46"
      },
      {
        points:
          "321.57 4.5 321.57 59.49 321.57 114.5 315.57 114.5 309.57 114.5 309.57 59.49 309.57 4.5 315.57 4.5 321.57 4.5"
      },
      {
        points:
          "339.14 4.5 339.14 175.5 313.29 175.5 313.29 116.5 323.57 116.5 323.57 4.5 339.14 4.5"
      },
      {
        points:
          "367 116.5 367 175.5 341.14 175.5 341.14 4.5 356.07 4.5 356.07 116.5 367 116.5"
      },
      {
        points:
          "370.07 4.5 370.07 59.49 370.07 114.5 364.07 114.5 358.07 114.5 358.07 59.49 358.07 4.5 364.07 4.5 370.07 4.5"
      },
      {
        points:
          "394.87 116.5 394.87 175.5 369 175.5 369 116.5 372.07 116.5 372.07 4.5 388.57 4.5 388.57 116.5 394.87 116.5"
      },
      {
        points:
          "402.57 4.5 402.57 59.49 402.57 114.5 396.57 114.5 390.57 114.5 390.57 59.49 390.57 4.5 396.57 4.5 402.57 4.5"
      },
      {
        points:
          "422.71 116.5 422.71 175.5 396.87 175.5 396.87 116.5 404.57 116.5 404.57 4.5 418.57 4.5 418.57 116.5 422.71 116.5"
      },
      {
        points:
          "432.57 4.5 432.57 59.49 432.57 114.5 426.57 114.5 420.57 114.5 420.57 59.49 420.57 4.5 426.57 4.5 432.57 4.5"
      },
      {
        points:
          "450.57 4.5 450.57 175.5 424.71 175.5 424.71 116.5 434.57 116.5 434.57 4.5 450.57 4.5"
      },
      {
        points:
          "470.07 116.5 478.44 116.5 478.44 175.5 452.57 175.5 452.57 4.5 470.07 4.5 470.07 116.5"
      },
      {
        points:
          "484.07 4.5 484.07 59.49 484.07 114.5 478.07 114.5 472.07 114.5 472.07 59.49 472.07 4.5 478.07 4.5 484.07 4.5"
      },
      {
        points:
          "506.52 175.46 480.68 175.53 480.5 116.5 486.07 116.5 486.07 4.51 502.57 4.46 502.57 116.5 506.36 116.5 506.52 175.46"
      },
      {
        points:
          "516.58 4.5 516.58 59.49 516.58 114.5 510.57 114.5 504.57 114.5 504.57 59.49 504.57 4.5 510.57 4.5 516.58 4.5"
      },
      {
        points:
          "534.14 4.5 534.14 175.5 508.29 175.5 508.29 116.5 518.58 116.5 518.58 4.5 534.14 4.5"
      },
      {
        points:
          "562 116.5 562 175.5 536.14 175.5 536.14 4.5 551.08 4.5 551.08 116.5 562 116.5"
      },
      {
        points:
          "565.08 4.5 565.08 59.49 565.08 114.5 559.08 114.5 553.08 114.5 553.08 59.49 553.08 4.5 559.08 4.5 565.08 4.5"
      },
      {
        points:
          "589.87 116.5 589.87 175.5 564 175.5 564 116.5 567.08 116.5 567.08 4.5 583.58 4.5 583.58 116.5 589.87 116.5"
      },
      {
        points:
          "597.58 4.5 597.58 59.49 597.58 114.5 591.58 114.5 585.58 114.5 585.58 59.49 585.58 4.5 591.58 4.5 597.58 4.5"
      },
      {
        points:
          "617.72 116.5 617.72 175.5 591.87 175.5 591.87 116.5 599.58 116.5 599.58 4.5 613.58 4.5 613.58 116.5 617.72 116.5"
      },
      {
        points:
          "627.58 4.5 627.58 59.49 627.58 114.5 621.58 114.5 615.58 114.5 615.58 59.49 615.58 4.5 621.58 4.5 627.58 4.5"
      },
      {
        points:
          "645.58 4.5 645.58 175.5 619.72 175.5 619.72 116.5 629.58 116.5 629.58 4.5 645.58 4.5"
      },
      {
        points:
          "665.08 116.5 673.43 116.5 673.43 175.5 647.58 175.5 647.58 4.5 665.08 4.5 665.08 116.5"
      },
      {
        points:
          "679.08 4.5 679.08 59.49 679.08 114.5 673.08 114.5 667.08 114.5 667.08 59.49 667.08 4.5 673.08 4.5 679.08 4.5"
      },
      {
        points:
          "701.52 175.46 675.67 175.53 675.5 116.5 681.08 116.5 681.08 4.51 697.58 4.46 697.58 116.5 701.36 116.5 701.52 175.46"
      },
      {
        points:
          "711.58 4.5 711.58 59.49 711.58 114.5 705.58 114.5 699.58 114.5 699.58 59.49 699.58 4.5 705.58 4.5 711.58 4.5"
      },
      {
        points:
          "729.14 4.5 729.14 175.5 703.28 175.5 703.28 116.5 713.58 116.5 713.58 4.5 729.14 4.5"
      },
      {
        points:
          "757 116.5 757 175.5 731.14 175.5 731.14 4.5 746.08 4.5 746.08 116.5 757 116.5"
      },
      {
        points:
          "760.08 4.5 760.08 59.49 760.08 114.5 754.08 114.5 748.08 114.5 748.08 59.49 748.08 4.5 754.08 4.5 760.08 4.5"
      },
      {
        points:
          "784.87 116.5 784.87 175.5 759 175.5 759 116.5 762.08 116.5 762.08 4.5 778.58 4.5 778.58 116.5 784.87 116.5"
      },
      {
        points:
          "792.58 4.5 792.58 59.49 792.58 114.5 786.58 114.5 780.58 114.5 780.58 59.49 780.58 4.5 786.58 4.5 792.58 4.5"
      },
      {
        points:
          "812.72 116.5 812.72 175.5 786.87 175.5 786.87 116.5 794.58 116.5 794.58 4.5 808.58 4.5 808.58 116.5 812.72 116.5"
      },
      {
        points:
          "822.58 4.5 822.58 59.49 822.58 114.5 816.58 114.5 810.58 114.5 810.58 59.49 810.58 4.5 816.58 4.5 822.58 4.5"
      },
      {
        points:
          "840.58 4.5 840.58 175.5 814.72 175.5 814.72 116.5 824.58 116.5 824.58 4.5 840.58 4.5"
      },
      {
        points:
          "860.08 116.5 868.43 116.5 868.43 175.5 842.58 175.5 842.58 4.5 860.08 4.5 860.08 116.5"
      },
      {
        points:
          "874.08 4.5 874.08 59.49 874.08 114.5 868.08 114.5 862.08 114.5 862.08 59.49 862.08 4.5 868.08 4.5 874.08 4.5"
      },
      {
        points:
          "896.52 175.46 870.67 175.53 870.5 116.5 876.08 116.5 876.08 4.51 892.58 4.46 892.58 116.5 896.36 116.5 896.52 175.46"
      },
      {
        points:
          "906.58 4.5 906.58 59.49 906.58 114.5 900.58 114.5 894.58 114.5 894.58 59.49 894.58 4.5 900.58 4.5 906.58 4.5"
      },
      {
        points:
          "924.14 4.5 924.14 175.5 898.28 175.5 898.28 116.5 908.58 116.5 908.58 4.5 924.14 4.5"
      },
      {
        points:
          "952 116.5 952 175.5 926.14 175.5 926.14 4.5 941.08 4.5 941.08 116.5 952 116.5"
      },
      {
        points:
          "955.08 4.5 955.08 59.49 955.08 114.5 949.08 114.5 943.08 114.5 943.08 59.49 943.08 4.5 949.08 4.5 955.08 4.5"
      },
      {
        points:
          "979.87 116.5 979.87 175.5 954 175.5 954 116.5 957.08 116.5 957.08 4.5 973.58 4.5 973.58 116.5 979.87 116.5"
      },
      {
        points:
          "987.58 4.5 987.58 59.49 987.58 114.5 981.58 114.5 975.58 114.5 975.58 59.49 975.58 4.5 981.58 4.5 987.58 4.5"
      },
      {
        points:
          "1007.72 116.5 1007.72 175.5 981.87 175.5 981.87 116.5 989.58 116.5 989.58 4.5 1003.58 4.5 1003.58 116.5 1007.72 116.5"
      },
      {
        points:
          "1017.58 4.5 1017.58 59.49 1017.58 114.5 1011.58 114.5 1005.58 114.5 1005.58 59.49 1005.58 4.5 1011.58 4.5 1017.58 4.5"
      },
      {
        points:
          "1035.58 4.5 1035.58 175.5 1009.72 175.5 1009.72 116.5 1019.58 116.5 1019.58 4.5 1035.58 4.5"
      },
      {
        points:
          "1055.08 116.5 1063.43 116.5 1063.43 175.5 1037.58 175.5 1037.58 4.5 1055.08 4.5 1055.08 116.5"
      },
      {
        points:
          "1069.08 4.5 1069.08 59.49 1069.08 114.5 1063.08 114.5 1057.08 114.5 1057.08 59.49 1057.08 4.5 1063.08 4.5 1069.08 4.5"
      },
      {
        points:
          "1091.53 175.46 1065.67 175.53 1065.51 116.5 1071.08 116.5 1071.08 4.51 1087.58 4.46 1087.58 116.5 1091.36 116.5 1091.53 175.46"
      },
      {
        points:
          "1101.58 4.5 1101.58 59.49 1101.58 114.5 1095.58 114.5 1089.58 114.5 1089.58 59.49 1089.58 4.5 1095.58 4.5 1101.58 4.5"
      },
      {
        points:
          "1119.14 4.5 1119.14 175.5 1093.29 175.5 1093.29 116.5 1103.58 116.5 1103.58 4.5 1119.14 4.5"
      },
      {
        points:
          "1147.01 116.5 1147.01 175.5 1121.14 175.5 1121.14 4.5 1136.08 4.5 1136.08 116.5 1147.01 116.5"
      },
      {
        points:
          "1150.08 4.5 1150.08 59.49 1150.08 114.5 1144.08 114.5 1138.08 114.5 1138.08 59.49 1138.08 4.5 1144.08 4.5 1150.08 4.5"
      },
      {
        points:
          "1174.87 116.5 1174.87 175.5 1149.01 175.5 1149.01 116.5 1152.08 116.5 1152.08 4.5 1168.58 4.5 1168.58 116.5 1174.87 116.5"
      },
      {
        points:
          "1182.58 4.5 1182.58 59.49 1182.58 114.5 1176.58 114.5 1170.58 114.5 1170.58 59.49 1170.58 4.5 1176.58 4.5 1182.58 4.5"
      },
      {
        points:
          "1202.71 116.5 1202.71 175.5 1176.87 175.5 1176.87 116.5 1184.58 116.5 1184.58 4.5 1198.58 4.5 1198.58 116.5 1202.71 116.5"
      },
      {
        points:
          "1212.58 4.5 1212.58 59.49 1212.58 114.5 1206.58 114.5 1200.58 114.5 1200.58 59.49 1200.58 4.5 1206.58 4.5 1212.58 4.5"
      },
      {
        points:
          "1230.58 4.5 1230.58 175.5 1204.71 175.5 1204.71 116.5 1214.58 116.5 1214.58 4.5 1230.58 4.5"
      },
      {
        points:
          "1250.08 116.5 1258.43 116.5 1258.43 175.5 1232.58 175.5 1232.58 4.5 1250.08 4.5 1250.08 116.5"
      },
      {
        points:
          "1264.08 4.5 1264.08 59.49 1264.08 114.5 1258.08 114.5 1252.08 114.5 1252.08 59.49 1252.08 4.5 1258.08 4.5 1264.08 4.5"
      },
      {
        points:
          "1286.53 175.46 1260.67 175.53 1260.51 116.5 1266.08 116.5 1266.08 4.51 1282.58 4.46 1282.58 116.5 1286.36 116.5 1286.53 175.46"
      },
      {
        points:
          "1296.58 4.5 1296.58 59.49 1296.58 114.5 1290.58 114.5 1284.58 114.5 1284.58 59.49 1284.58 4.5 1290.58 4.5 1296.58 4.5"
      },
      {
        points:
          "1314.14 4.5 1314.14 175.5 1288.29 175.5 1288.29 116.5 1298.58 116.5 1298.58 4.5 1314.14 4.5"
      },
      {
        points:
          "1342.01 116.5 1342.01 175.5 1316.14 175.5 1316.14 4.5 1331.08 4.5 1331.08 116.5 1342.01 116.5"
      },
      {
        points:
          "1345.08 4.5 1345.08 59.49 1345.08 114.5 1339.08 114.5 1333.08 114.5 1333.08 59.49 1333.08 4.5 1339.08 4.5 1345.08 4.5"
      },
      {
        points:
          "1369.87 116.5 1369.87 175.5 1344.01 175.5 1344.01 116.5 1347.08 116.5 1347.08 4.5 1363.58 4.5 1363.58 116.5 1369.87 116.5"
      },
      {
        points:
          "1377.58 4.5 1377.58 59.49 1377.58 114.5 1371.58 114.5 1365.58 114.5 1365.58 59.49 1365.58 4.5 1371.58 4.5 1377.58 4.5"
      },
      {
        points:
          "1397.71 116.5 1397.71 175.5 1371.87 175.5 1371.87 116.5 1379.58 116.5 1379.58 4.5 1393.58 4.5 1393.58 116.5 1397.71 116.5"
      },
      {
        points:
          "1407.58 4.5 1407.58 59.49 1407.58 114.5 1401.58 114.5 1395.58 114.5 1395.58 59.49 1395.58 4.5 1401.58 4.5 1407.58 4.5"
      },
      {
        points:
          "1425.58 4.5 1425.58 175.5 1399.71 175.5 1399.71 116.5 1409.58 116.5 1409.58 4.5 1425.58 4.5"
      },
      {
        points:
          "1453.43 4.5 1453.43 90 1453.43 175.5 1440.51 175.5 1427.58 175.5 1427.58 90 1427.58 4.5 1440.51 4.5 1453.43 4.5"
      }
    ],
    blackKeys: [],
    realKeys: [],
    mouseState: false,
    isMounted: false
  }),
  mounted() {
    this.buildBlackKeys();
    this.buildKeys();
    this.isMounted = true;
    this.$el.addEventListener('mousedown', () => {
      this.mouseState = true;
    })
    this.$el.addEventListener('mouseup', () => {
      this.mouseState = false;
    })
  },
  methods: {
    hoverKey(key, state) {
      key.hover = state;
      if (!state && !this.mouseState) {
        // do nothing
      } else if (this.mouseState && state)
        this.clickedKey(key, true)
      else if (!this.mouseState && !state) 
        this.clickedKey(key, false)
      else if (key.state && !state) 
        this.clickedKey(key, false)
    },
    clickedKey(key, state) {
      key.state = state;
      this.$emit(state ? 'keyDown' : 'keyUp', key)
    },
    buildBlackKeys() {
      let results = [1];
      let modifiers = [1, 3, 6, 8, 10];
      for (var i = 0; i < 7; i++) {
        let baseKey = i * 12 + 3;
        let octave = modifiers.map(key => {
          return baseKey + key;
        });
        results = [].concat(results, octave);
      }
      this.blackKeys = results;
    },
    buildKeys() {
      this.realKeys = [];
      for (var i = 0; i < this.keys.length; i++) {
        let points = this.keys[i].points;
        let key = {
          index: i,
          state: false,
          velocity: 0,
          points: points,
          isBlack: this.blackKeys.includes(i),
          hover: false,
          class: this.blackKeys.includes(i)
            ? "keyboard-black"
            : "keyboard-white"
        };
        this.realKeys.push(key);
      }
      console.log("Key creation complete");
      console.log(this.realKeys);
    },
    styleKey(key) {
      if (!this.isMounted) {
        return ``;
      } else {
        let style = ``;
        // If key is not hovering, or is hovering but being pressed
        if (!key.hover || key.state)
          style = `
          fill: var(--color-${
            key.state
              ? "default"
              : key.isBlack
              ? "scrollbar-thumb"
              : "scrollbar-arrow"
          });
        `;
        else style = `fill: var(--color-text-label)`;
        return style;
      }
    },
    setKey(args) {
      let key = this.realKeys[args[1] - 21];
      key.state = args[0] == 144;
      key.velocity = args[2];
    },
    resetKey(args) {
      let key = this.realKeys[args[1] - 21];
      key.state = false;
      key.velocity = 0;
    }
  }
};
</script>

<style>
svg {
  width: 100%;
  max-height: 90px;
  min-height: 60px;
}

.keyboard-bg {
  fill: var(--color-bg);
}
.keyboard-white {
  fill: var(--color-scrollbar-arrow);
}
.keyboard-black {
  fill: var(--color-scrollbar-thumb);
}
.keyboard-black,
.keyboard-white {
  transition: fill 80ms var(--quint) 0ms;
}
</style>